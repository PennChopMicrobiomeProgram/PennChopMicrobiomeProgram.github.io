---
layout: default
---

<style>
  .post-list {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    list-style-type: none;
    padding: 0;
  }

  .post-list li {
    background: #f4f4f4;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
  }

  .post-list a {
    text-decoration: none;
    color: #333;
  }
</style>

<div class="home">

  <h1 class="page-heading">Software</h1>

  <ul class="post-list">
    <script>
      async function fetchRepositories() {
        var now = new Date().getTime();
        var cacheTimestamp = localStorage.getItem('reposTimestamp');
        let repos = JSON.parse(localStorage.getItem('repos')) || [];

        if (!cacheTimestamp || (now - cacheTimestamp) > 20 * 60 * 1000) { // 20 minutes in milliseconds
          const PCMPresponse = await fetch(`https://api.github.com/orgs/PennChopMicrobiomeProgram/repos`, {
            headers: {
              'User-Agent': 'request'
            }
          });
          const PCMPrepos = await PCMPresponse.json();
          const SLresponse = await fetch(`https://api.github.com/orgs/sunbeam-labs/repos`, {
            headers: {
              'User-Agent': 'request'
            }
          });
          const SLrepos = await SLresponse.json();
          repos = [...PCMPrepos, ...SLrepos];

          localStorage.setItem('repos', JSON.stringify(repos));
          localStorage.setItem('reposTimestamp', now);
        }

        // Sort repos by 'updated_at'
        repos.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));

        const ul = document.querySelector('.post-list');
        repos.forEach(repo => {
            const li = document.createElement('li');
            li.id = repo.name;
            const a = document.createElement('a');
            a.href = repo.html_url;
            a.textContent = repo.name;
            li.appendChild(a);

            const issues = document.createElement('p');
            issues.textContent = `Open issues: ${repo.open_issues}`;
            li.appendChild(issues);

            ul.appendChild(li);
        });

        const workflows = JSON.parse(localStorage.getItem('workflows')) || [];
        cacheTimestamp = localStorage.getItem('workflowsTimestamp');
        now = new Date().getTime();

        if (!cacheTimestamp || (now - cacheTimestamp) > 20 * 60 * 1000) { // 20 minutes in milliseconds
          for (const repo of repos) {
            const url = `https://api.github.com/repos/${repo.full_name}/actions/workflows`;
            const response = await fetch(url);
            const data = await response.json();
            const activeWorkflows = data.workflows.filter(workflow => workflow.state === 'active' && workflow.badge_url);
            if (activeWorkflows.length > 0) {
              workflows.push({
                repo: repo.name,
                workflows: activeWorkflows
              });
            }
          }
          localStorage.setItem('workflows', JSON.stringify(workflows));
          localStorage.setItem('workflowsTimestamp', now);
        }

        workflows.forEach(workflowData => {
          const repoLi = document.getElementById(workflowData.repo);
          if (repoLi) {
            const div = document.createElement('div');
            div.style.display = 'flex';
            div.style.flexWrap = 'wrap'; // Add flex-wrap to allow wrapping
            workflowData.workflows.forEach(workflow => {
              const img = document.createElement('img');
              img.src = workflow.badge_url;
              img.style.marginRight = '10px'; // Optional: Add some spacing between images
              img.style.marginBottom = '10px'; // Optional: Add some spacing between rows
              div.appendChild(img);
            });
            repoLi.appendChild(div);
          }
        });
      }

      fetchRepositories();
    </script>
  </ul>

</div>